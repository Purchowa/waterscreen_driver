#include <stdarg.h>
#include <setjmp.h>
#include <cmocka.h>

#include "picture_management/picture_types.h"
#include "http/webpicture_parser.h"

#include <string.h>

static pictureRow_t  customPictureBuffer[MAX_CUSTOM_PICTURE_HEIGHT];
static PictureInfo_t customPicture = { .picture = { .data = customPictureBuffer } };

static int setupCustomPicture()
{
    customPicture.picture.size = 0;
    memset( customPicture.picture.data, 0, MAX_CUSTOM_PICTURE_HEIGHT * sizeof( *customPicture.picture.data ) );

    return 0;
}

static bool compareRGB( const ColorRGB_t *first, const ColorRGB_t *second )
{
    bool areEqual = true;

    areEqual &= first->r == second->r;
    areEqual &= first->g == second->g;
    areEqual &= first->b == second->b;

    return areEqual;
}

static bool comparePictures( const PictureInfo_t *first, const PictureInfo_t *second )
{
    bool areEqual = true;

    areEqual &= first->picture.size == second->picture.size;
    if ( areEqual )
        areEqual &=
            !memcmp( first->picture.data, second->picture.data, first->picture.size * sizeof( *first->picture.data ) );

    areEqual &= compareRGB( &first->colors.main, &second->colors.main );
    areEqual &= compareRGB( &first->colors.secondary, &second->colors.secondary );

    return areEqual;
}

void givenReadPicture_pictureParser_returnHttpSuccess()
{
    bool        wasRead    = false;
    const char *sampleJson = "{\"wasRead\":true}";

    assert_int_equal( parseJsonToWasReadFlag( sampleJson, &wasRead ), Http_Success );
    assert_int_equal( wasRead, true );
}

void givenRawValidJson_pictureParser_parsePicture()
{
    const char *sampleJson = "{\"size\":4,\"data\":[\"18446744073709551615\",\"0\",\"24\",\"-1\"],"
                             " \"colors\": { "
                             "  \"main\": { \"r\": 0, \"g\": 100, \"b\": 255 },"
                             "  \"secondary\":{ \"r\": 255, \"g\": 100, \"b\": 0 } } } ";

    pictureRow_t  expectedPictureData[MAX_CUSTOM_PICTURE_HEIGHT] = { UINT64_MAX, 0, 24, UINT64_MAX };
    PictureInfo_t expectedCustomPicture = { .picture = { .size = 4, .data = expectedPictureData },
                                            .colors  = { .main = { 0, 100, 255 }, .secondary = { 255, 100, 0 } } };

    assert_int_equal( parseJsonToCustomPicture( sampleJson, &customPicture ), Http_Success );
    assert_true( comparePictures( &expectedCustomPicture, &customPicture ) );
}

void givenArrayShorterThanSize_pictureParser_returnParsingError()
{
    const char *invalidArrayWithSize = "{\"size\":4,\"data\":[\"0\",\"0\",\"24\"],"
                                       " \"colors\": { "
                                       "  \"main\": { \"r\": 0, \"g\": 100, \"b\": 200 },"
                                       "  \"secondary\":{ \"r\": 200, \"g\": 100, \"b\": 0 } } }";
    assert_int_equal( parseJsonToCustomPicture( invalidArrayWithSize, &customPicture ), Http_WebPictureParsingError );
}

void givenInvalidSize_configParser_returnSuccessAndClamp()
{
    const char *invlaidSize_lower = "{\"size\":-1,\"data\":[\"0\",\"0\",\"24\",\"1567\"],"
                                    " \"colors\": { "
                                    "  \"main\": { \"r\": 0, \"g\": 100, \"b\": 200 },"
                                    "  \"secondary\":{ \"r\": 200, \"g\": 100, \"b\": 0 } } }";

    pictureRow_t  expectedPictureData[MAX_CUSTOM_PICTURE_HEIGHT] = {};
    PictureInfo_t expectedCustomPicture = { .picture = { .size = 0, .data = expectedPictureData },
                                            .colors  = { .main = { 0, 100, 200 }, .secondary = { 200, 100, 0 } } };

    assert_int_equal( parseJsonToCustomPicture( invlaidSize_lower, &customPicture ), Http_Success );
    assert_true( comparePictures( &expectedCustomPicture, &customPicture ) );

    setupCustomPicture();

    const char *invlaidSize_higher =
        "{\"size\":1025,\"data\":[\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\",\"0\","
        "\"0\",\"0\",\"0\"],"
        " \"colors\": { "
        "  \"main\": { \"r\": 0, \"g\": 100, \"b\": 200 },"
        "  \"secondary\":{ \"r\": 200, \"g\": 100, \"b\": 0 } "
        " }"
        "}";


    expectedCustomPicture.picture.size = MAX_CUSTOM_PICTURE_HEIGHT;
    memset( expectedCustomPicture.picture.data, 0,
            expectedCustomPicture.picture.size * sizeof( *expectedCustomPicture.picture.data ) );

    assert_int_equal( parseJsonToCustomPicture( invlaidSize_higher, &customPicture ), Http_Success );
    assert_true( comparePictures( &expectedCustomPicture, &customPicture ) );
}

int main()
{
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_setup( givenRawValidJson_pictureParser_parsePicture, setupCustomPicture ),
        cmocka_unit_test_setup( givenArrayShorterThanSize_pictureParser_returnParsingError, setupCustomPicture ),
        cmocka_unit_test_setup( givenInvalidSize_configParser_returnSuccessAndClamp, setupCustomPicture ),
        cmocka_unit_test_setup( givenReadPicture_pictureParser_returnHttpSuccess, setupCustomPicture ),
    };

    return cmocka_run_group_tests_name( "JSON web picture parser", tests, NULL, NULL );
}
